<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 任务管理中心 - Bilibili 收藏夹</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'kawaii-pink': '#FFB7D1',
                        'kawaii-purple': '#C8A8E9',
                        'kawaii-blue': '#A8D8EA',
                        'kawaii-yellow': '#FFFACD',
                        'kawaii-mint': '#B8E6B8',
                    },
                    animation: {
                        'bounce-slow': 'bounce 2s infinite',
                        'pulse-slow': 'pulse 3s infinite',
                        'progress': 'progress 2s ease-in-out infinite',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap');
        * {
            font-family: 'Noto Sans SC', sans-serif;
        }
        body {
            background: linear-gradient(135deg, #FFE4E6 0%, #E8D5FF 50%, #D1E7FF 100%);
            min-height: 100vh;
        }
        @keyframes progress {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .task-progress::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 30%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: progress 2s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // 任务状态映射
        const taskStatusMap = {
            'pending': { text: '等待中', color: 'bg-yellow-100 text-yellow-800', icon: '⏳' },
            'running': { text: '运行中', color: 'bg-blue-100 text-blue-800', icon: '🚀' },
            'completed': { text: '已完成', color: 'bg-green-100 text-green-800', icon: '✅' },
            'failed': { text: '失败', color: 'bg-red-100 text-red-800', icon: '❌' },
            'cancelled': { text: '已取消', color: 'bg-gray-100 text-gray-800', icon: '⛔' },
            'paused': { text: '已暂停', color: 'bg-purple-100 text-purple-800', icon: '⏸️' }
        };

        // 任务类型映射
        const taskTypeMap = {
            'video_download': { text: '视频下载', icon: '📹' },
            'sync_favorites': { text: '同步收藏夹', icon: '🔄' },
            'batch_download': { text: '批量下载', icon: '📦' }
        };

        function TaskManager() {
            const [tasks, setTasks] = useState([]);
            const [loading, setLoading] = useState(true);
            const [statusFilter, setStatusFilter] = useState('all');
            const [typeFilter, setTypeFilter] = useState('all');
            const [currentTask, setCurrentTask] = useState(null);
            const [systemStatus, setSystemStatus] = useState(null);
            const intervalRef = useRef(null);

            useEffect(() => {
                fetchTasks();
                fetchSystemStatus();
                
                // 定期刷新任务状态
                intervalRef.current = setInterval(() => {
                    fetchTasks();
                    fetchCurrentTask();
                }, 2000);

                return () => {
                    if (intervalRef.current) {
                        clearInterval(intervalRef.current);
                    }
                };
            }, [statusFilter, typeFilter]);

            const fetchTasks = async () => {
                try {
                    let url = '/api/tasks/list';
                    const params = new URLSearchParams();
                    if (statusFilter !== 'all') params.append('status', statusFilter);
                    if (typeFilter !== 'all') params.append('type', typeFilter);
                    
                    if (params.toString()) {
                        url += '?' + params.toString();
                    }

                    const response = await fetch(url);
                    const data = await response.json();
                    setTasks(data.tasks || []);
                } catch (err) {
                    console.error('获取任务列表失败:', err);
                } finally {
                    setLoading(false);
                }
            };

            const fetchCurrentTask = async () => {
                try {
                    const response = await fetch('/api/tasks/current');
                    if (response.ok) {
                        const data = await response.json();
                        setCurrentTask(data);
                    }
                } catch (err) {
                    console.error('获取当前任务失败:', err);
                }
            };

            const fetchSystemStatus = async () => {
                try {
                    const response = await fetch('/api/tasks/system/status');
                    if (response.ok) {
                        const data = await response.json();
                        setSystemStatus(data);
                    }
                } catch (err) {
                    console.error('获取系统状态失败:', err);
                }
            };

            const handleTaskAction = async (taskId, action) => {
                try {
                    const response = await fetch(`/api/tasks/${action}/${taskId}`, {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        fetchTasks();
                        if (action === 'cancel') {
                            setCurrentTask(null);
                        }
                    }
                } catch (err) {
                    console.error(`执行任务操作失败:`, err);
                }
            };

            const handleCleanupOldTasks = async () => {
                try {
                    const response = await fetch('/api/tasks/system/cleanup', {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        alert(`清理完成，删除了 ${result.deleted_count} 个旧任务`);
                        fetchTasks();
                    }
                } catch (err) {
                    console.error('清理旧任务失败:', err);
                }
            };

            const ProgressBar = ({ progress }) => {
                const percentage = progress?.percentage || 0;
                return (
                    <div className="w-full bg-gray-200 rounded-full h-2 relative overflow-hidden">
                        <div 
                            className="bg-gradient-to-r from-kawaii-pink to-kawaii-purple h-2 rounded-full transition-all duration-300 relative task-progress"
                            style={ { width: `${percentage}%` } }
                        ></div>
                    </div>
                );
            };

            const TaskCard = ({ task }) => {
                const status = taskStatusMap[task.status] || taskStatusMap.pending;
                const type = taskTypeMap[task.task_type] || { text: task.task_type, icon: '📋' };

                return (
                    <div className="bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-lg border border-pink-200/50 hover:shadow-xl transition-all duration-300">
                        {/* 任务头部 */}
                        <div className="flex items-center justify-between mb-4">
                            <div className="flex items-center space-x-3">
                                <span className="text-2xl">{type.icon}</span>
                                <div>
                                    <h3 className="font-semibold text-gray-800">{task.title}</h3>
                                    <p className="text-sm text-gray-500">{type.text}</p>
                                </div>
                            </div>
                            <span className={`px-3 py-1 rounded-full text-sm font-medium ${status.color}`}>
                                {status.icon} {status.text}
                            </span>
                        </div>

                        {/* 进度条（仅对运行中的任务显示） */}
                        {task.status === 'running' && task.progress && (
                            <div className="mb-4">
                                <div className="flex justify-between text-sm text-gray-600 mb-2">
                                    <span>{task.progress.message || '处理中...'}</span>
                                    <span>{Math.round(task.progress.percentage || 0)}%</span>
                                </div>
                                <ProgressBar progress={task.progress} />
                            </div>
                        )}

                        {/* 任务信息 */}
                        <div className="text-sm text-gray-600 space-y-1 mb-4">
                            <div>创建时间: {new Date(task.created_at).toLocaleString()}</div>
                            {task.started_at && (
                                <div>开始时间: {new Date(task.started_at).toLocaleString()}</div>
                            )}
                            {task.completed_at && (
                                <div>完成时间: {new Date(task.completed_at).toLocaleString()}</div>
                            )}
                        </div>

                        {/* 结果信息 */}
                        {task.result && (
                            <div className="mb-4">
                                {task.result.success ? (
                                    <div className="text-green-600 text-sm">
                                        ✅ 任务执行成功
                                        {task.result.output_files && task.result.output_files.length > 0 && (
                                            <div className="mt-1">
                                                📁 输出文件: {task.result.output_files[0]}
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <div className="text-red-600 text-sm">
                                        ❌ 执行失败: {task.result.error_message}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* 操作按钮 */}
                        <div className="flex space-x-2">
                            {task.status === 'pending' && (
                                <>
                                    <button
                                        onClick={() => handleTaskAction(task.task_id, 'cancel')}
                                        className="px-3 py-1 bg-red-100 text-red-600 rounded-lg text-sm hover:bg-red-200 transition-colors"
                                    >
                                        取消
                                    </button>
                                    <button
                                        onClick={() => handleTaskAction(task.task_id, 'pause')}
                                        className="px-3 py-1 bg-purple-100 text-purple-600 rounded-lg text-sm hover:bg-purple-200 transition-colors"
                                    >
                                        暂停
                                    </button>
                                </>
                            )}
                            {task.status === 'paused' && (
                                <button
                                    onClick={() => handleTaskAction(task.task_id, 'resume')}
                                    className="px-3 py-1 bg-blue-100 text-blue-600 rounded-lg text-sm hover:bg-blue-200 transition-colors"
                                >
                                    恢复
                                </button>
                            )}
                            {task.status === 'failed' && (
                                <button
                                    onClick={() => handleTaskAction(task.task_id, 'retry')}
                                    className="px-3 py-1 bg-yellow-100 text-yellow-600 rounded-lg text-sm hover:bg-yellow-200 transition-colors"
                                >
                                    重试
                                </button>
                            )}
                            {['completed', 'failed', 'cancelled'].includes(task.status) && (
                                <button
                                    onClick={() => handleTaskAction(task.task_id, 'delete')}
                                    className="px-3 py-1 bg-gray-100 text-gray-600 rounded-lg text-sm hover:bg-gray-200 transition-colors"
                                >
                                    删除
                                </button>
                            )}
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen">
                    {/* 导航栏 */}
                    <nav className="bg-gradient-to-r from-kawaii-pink to-kawaii-purple shadow-lg">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between h-16 items-center">
                                <div className="flex items-center space-x-4">
                                    <h1 className="text-2xl font-bold text-white">
                                        🚀 任务管理中心
                                    </h1>
                                </div>
                                <div className="flex space-x-6">
                                    <a href="/" className="text-white hover:text-kawaii-yellow transition-colors duration-300 font-medium">
                                        🏠 首页
                                    </a>
                                    <a href="/sync" className="text-white hover:text-kawaii-yellow transition-colors duration-300 font-medium">
                                        🔄 同步管理
                                    </a>
                                    <a href="/tasks" className="text-kawaii-yellow font-medium">
                                        🚀 任务管理
                                    </a>
                                    <a href="/stats" className="text-white hover:text-kawaii-yellow transition-colors duration-300 font-medium">
                                        📊 统计信息
                                    </a>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <div className="max-w-7xl mx-auto px-4 py-8">
                        {/* 标题和当前任务状态 */}
                        <div className="mb-8">
                            <h2 className="text-3xl font-bold bg-gradient-to-r from-pink-500 via-purple-500 to-blue-500 bg-clip-text text-transparent mb-4">
                                任务管理中心 🎯
                            </h2>
                            
                            {/* 当前任务状态 */}
                            {currentTask && (
                                <div className="bg-blue-50 border border-blue-200 rounded-2xl p-4 mb-6">
                                    <h3 className="font-semibold text-blue-800 mb-2">🔥 当前执行任务</h3>
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <span className="font-medium">{currentTask.title}</span>
                                            <span className="text-sm text-gray-600 ml-2">
                                                {currentTask.progress?.message || '处理中...'}
                                            </span>
                                        </div>
                                        <div className="text-sm text-blue-600">
                                            {Math.round(currentTask.progress?.percentage || 0)}%
                                        </div>
                                    </div>
                                    <div className="mt-2">
                                        <ProgressBar progress={currentTask.progress} />
                                    </div>
                                </div>
                            )}

                            {/* 系统状态 */}
                            {systemStatus && (
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                    <div className="bg-white/80 rounded-2xl p-4 text-center">
                                        <div className="text-2xl text-yellow-500 mb-2">⏳</div>
                                        <div className="font-semibold">{systemStatus.statistics?.status_distribution?.pending || 0}</div>
                                        <div className="text-sm text-gray-600">等待中</div>
                                    </div>
                                    <div className="bg-white/80 rounded-2xl p-4 text-center">
                                        <div className="text-2xl text-blue-500 mb-2">🚀</div>
                                        <div className="font-semibold">{systemStatus.statistics?.status_distribution?.running || 0}</div>
                                        <div className="text-sm text-gray-600">运行中</div>
                                    </div>
                                    <div className="bg-white/80 rounded-2xl p-4 text-center">
                                        <div className="text-2xl text-green-500 mb-2">✅</div>
                                        <div className="font-semibold">{systemStatus.statistics?.status_distribution?.completed || 0}</div>
                                        <div className="text-sm text-gray-600">已完成</div>
                                    </div>
                                    <div className="bg-white/80 rounded-2xl p-4 text-center">
                                        <div className="text-2xl text-red-500 mb-2">❌</div>
                                        <div className="font-semibold">{systemStatus.statistics?.status_distribution?.failed || 0}</div>
                                        <div className="text-sm text-gray-600">失败</div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* 筛选器和操作 */}
                        <div className="bg-white/90 backdrop-blur-sm rounded-2xl p-6 mb-8 shadow-lg border border-pink-200/50">
                            <div className="flex flex-wrap items-center justify-between gap-4">
                                <div className="flex flex-wrap items-center gap-4">
                                    <div className="flex items-center space-x-2">
                                        <label className="text-sm font-medium text-gray-700">状态筛选:</label>
                                        <select
                                            value={statusFilter}
                                            onChange={(e) => setStatusFilter(e.target.value)}
                                            className="border border-gray-300 rounded-lg px-3 py-1 text-sm"
                                        >
                                            <option value="all">全部</option>
                                            <option value="pending">等待中</option>
                                            <option value="running">运行中</option>
                                            <option value="completed">已完成</option>
                                            <option value="failed">失败</option>
                                            <option value="cancelled">已取消</option>
                                        </select>
                                    </div>
                                    <div className="flex items-center space-x-2">
                                        <label className="text-sm font-medium text-gray-700">类型筛选:</label>
                                        <select
                                            value={typeFilter}
                                            onChange={(e) => setTypeFilter(e.target.value)}
                                            className="border border-gray-300 rounded-lg px-3 py-1 text-sm"
                                        >
                                            <option value="all">全部</option>
                                            <option value="video_download">视频下载</option>
                                            <option value="sync_favorites">同步收藏夹</option>
                                            <option value="batch_download">批量下载</option>
                                        </select>
                                    </div>
                                </div>
                                <div className="flex space-x-2">
                                    <button
                                        onClick={fetchTasks}
                                        className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm"
                                    >
                                        🔄 刷新
                                    </button>
                                    <button
                                        onClick={handleCleanupOldTasks}
                                        className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm"
                                    >
                                        🧹 清理旧任务
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* 任务列表 */}
                        <div className="bg-white/80 backdrop-blur-sm rounded-3xl shadow-xl p-8 border border-pink-200">
                            {loading && (
                                <div className="text-center py-16">
                                    <div className="inline-block animate-spin rounded-full h-16 w-16 border-4 border-kawaii-pink border-t-transparent mb-4"></div>
                                    <p className="text-kawaii-purple font-medium text-lg">正在加载任务列表... 🌟</p>
                                </div>
                            )}

                            {!loading && tasks.length === 0 && (
                                <div className="text-center py-16">
                                    <div className="text-6xl mb-4">📋</div>
                                    <p className="text-gray-500 font-medium text-lg mb-4">
                                        没有找到任务
                                    </p>
                                    <p className="text-gray-400">
                                        当前筛选条件下没有任务，试试调整筛选条件吧 ✨
                                    </p>
                                </div>
                            )}

                            {!loading && tasks.length > 0 && (
                                <div className="space-y-4">
                                    {tasks.map((task) => (
                                        <TaskCard key={task.task_id} task={task} />
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<TaskManager />, document.getElementById('root'));
    </script>
</body>
</html> 