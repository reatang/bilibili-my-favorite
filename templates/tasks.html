<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ ä»»åŠ¡ç®¡ç†ä¸­å¿ƒ - Bilibili æ”¶è—å¤¹</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'kawaii-pink': '#FFB7D1',
                        'kawaii-purple': '#C8A8E9',
                        'kawaii-blue': '#A8D8EA',
                        'kawaii-yellow': '#FFFACD',
                        'kawaii-mint': '#B8E6B8',
                    },
                    animation: {
                        'bounce-slow': 'bounce 2s infinite',
                        'pulse-slow': 'pulse 3s infinite',
                        'progress': 'progress 2s ease-in-out infinite',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap');
        * {
            font-family: 'Noto Sans SC', sans-serif;
        }
        body {
            background: linear-gradient(135deg, #FFE4E6 0%, #E8D5FF 50%, #D1E7FF 100%);
            min-height: 100vh;
        }
        @keyframes progress {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .task-progress::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 30%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: progress 2s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ä»»åŠ¡çŠ¶æ€æ˜ å°„
        const taskStatusMap = {
            'pending': { text: 'ç­‰å¾…ä¸­', color: 'bg-yellow-100 text-yellow-800', icon: 'â³' },
            'running': { text: 'è¿è¡Œä¸­', color: 'bg-blue-100 text-blue-800', icon: 'ğŸš€' },
            'completed': { text: 'å·²å®Œæˆ', color: 'bg-green-100 text-green-800', icon: 'âœ…' },
            'failed': { text: 'å¤±è´¥', color: 'bg-red-100 text-red-800', icon: 'âŒ' },
            'cancelled': { text: 'å·²å–æ¶ˆ', color: 'bg-gray-100 text-gray-800', icon: 'â›”' },
            'paused': { text: 'å·²æš‚åœ', color: 'bg-purple-100 text-purple-800', icon: 'â¸ï¸' }
        };

        // ä»»åŠ¡ç±»å‹æ˜ å°„
        const taskTypeMap = {
            'video_download': { text: 'è§†é¢‘ä¸‹è½½', icon: 'ğŸ“¹' },
            'sync_favorites': { text: 'åŒæ­¥æ”¶è—å¤¹', icon: 'ğŸ”„' },
            'batch_download': { text: 'æ‰¹é‡ä¸‹è½½', icon: 'ğŸ“¦' }
        };

        function TaskManager() {
            const [tasks, setTasks] = useState([]);
            const [loading, setLoading] = useState(true);
            const [statusFilter, setStatusFilter] = useState('all');
            const [typeFilter, setTypeFilter] = useState('all');
            const [currentTask, setCurrentTask] = useState(null);
            const [systemStatus, setSystemStatus] = useState(null);
            const intervalRef = useRef(null);

            useEffect(() => {
                fetchTasks();
                fetchSystemStatus();
                
                // å®šæœŸåˆ·æ–°ä»»åŠ¡çŠ¶æ€
                intervalRef.current = setInterval(() => {
                    fetchTasks();
                    fetchCurrentTask();
                }, 2000);

                return () => {
                    if (intervalRef.current) {
                        clearInterval(intervalRef.current);
                    }
                };
            }, [statusFilter, typeFilter]);

            const fetchTasks = async () => {
                try {
                    let url = '/api/tasks/list';
                    const params = new URLSearchParams();
                    if (statusFilter !== 'all') params.append('status', statusFilter);
                    if (typeFilter !== 'all') params.append('type', typeFilter);
                    
                    if (params.toString()) {
                        url += '?' + params.toString();
                    }

                    const response = await fetch(url);
                    const data = await response.json();
                    setTasks(data.tasks || []);
                } catch (err) {
                    console.error('è·å–ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', err);
                } finally {
                    setLoading(false);
                }
            };

            const fetchCurrentTask = async () => {
                try {
                    const response = await fetch('/api/tasks/current');
                    if (response.ok) {
                        const data = await response.json();
                        setCurrentTask(data);
                    }
                } catch (err) {
                    console.error('è·å–å½“å‰ä»»åŠ¡å¤±è´¥:', err);
                }
            };

            const fetchSystemStatus = async () => {
                try {
                    const response = await fetch('/api/tasks/system/status');
                    if (response.ok) {
                        const data = await response.json();
                        setSystemStatus(data);
                    }
                } catch (err) {
                    console.error('è·å–ç³»ç»ŸçŠ¶æ€å¤±è´¥:', err);
                }
            };

            const handleTaskAction = async (taskId, action) => {
                try {
                    const response = await fetch(`/api/tasks/${action}/${taskId}`, {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        fetchTasks();
                        if (action === 'cancel') {
                            setCurrentTask(null);
                        }
                    }
                } catch (err) {
                    console.error(`æ‰§è¡Œä»»åŠ¡æ“ä½œå¤±è´¥:`, err);
                }
            };

            const handleCleanupOldTasks = async () => {
                try {
                    const response = await fetch('/api/tasks/system/cleanup', {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        alert(`æ¸…ç†å®Œæˆï¼Œåˆ é™¤äº† ${result.deleted_count} ä¸ªæ—§ä»»åŠ¡`);
                        fetchTasks();
                    }
                } catch (err) {
                    console.error('æ¸…ç†æ—§ä»»åŠ¡å¤±è´¥:', err);
                }
            };

            const ProgressBar = ({ progress }) => {
                const percentage = progress?.percentage || 0;
                return (
                    <div className="w-full bg-gray-200 rounded-full h-2 relative overflow-hidden">
                        <div 
                            className="bg-gradient-to-r from-kawaii-pink to-kawaii-purple h-2 rounded-full transition-all duration-300 relative task-progress"
                            style={ { width: `${percentage}%` } }
                        ></div>
                    </div>
                );
            };

            const TaskCard = ({ task }) => {
                const status = taskStatusMap[task.status] || taskStatusMap.pending;
                const type = taskTypeMap[task.task_type] || { text: task.task_type, icon: 'ğŸ“‹' };

                return (
                    <div className="bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-lg border border-pink-200/50 hover:shadow-xl transition-all duration-300">
                        {/* ä»»åŠ¡å¤´éƒ¨ */}
                        <div className="flex items-center justify-between mb-4">
                            <div className="flex items-center space-x-3">
                                <span className="text-2xl">{type.icon}</span>
                                <div>
                                    <h3 className="font-semibold text-gray-800">{task.title}</h3>
                                    <p className="text-sm text-gray-500">{type.text}</p>
                                </div>
                            </div>
                            <span className={`px-3 py-1 rounded-full text-sm font-medium ${status.color}`}>
                                {status.icon} {status.text}
                            </span>
                        </div>

                        {/* è¿›åº¦æ¡ï¼ˆä»…å¯¹è¿è¡Œä¸­çš„ä»»åŠ¡æ˜¾ç¤ºï¼‰ */}
                        {task.status === 'running' && task.progress && (
                            <div className="mb-4">
                                <div className="flex justify-between text-sm text-gray-600 mb-2">
                                    <span>{task.progress.message || 'å¤„ç†ä¸­...'}</span>
                                    <span>{Math.round(task.progress.percentage || 0)}%</span>
                                </div>
                                <ProgressBar progress={task.progress} />
                            </div>
                        )}

                        {/* ä»»åŠ¡ä¿¡æ¯ */}
                        <div className="text-sm text-gray-600 space-y-1 mb-4">
                            <div>åˆ›å»ºæ—¶é—´: {new Date(task.created_at).toLocaleString()}</div>
                            {task.started_at && (
                                <div>å¼€å§‹æ—¶é—´: {new Date(task.started_at).toLocaleString()}</div>
                            )}
                            {task.completed_at && (
                                <div>å®Œæˆæ—¶é—´: {new Date(task.completed_at).toLocaleString()}</div>
                            )}
                        </div>

                        {/* ç»“æœä¿¡æ¯ */}
                        {task.result && (
                            <div className="mb-4">
                                {task.result.success ? (
                                    <div className="text-green-600 text-sm">
                                        âœ… ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ
                                        {task.result.output_files && task.result.output_files.length > 0 && (
                                            <div className="mt-1">
                                                ğŸ“ è¾“å‡ºæ–‡ä»¶: {task.result.output_files[0]}
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <div className="text-red-600 text-sm">
                                        âŒ æ‰§è¡Œå¤±è´¥: {task.result.error_message}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* æ“ä½œæŒ‰é’® */}
                        <div className="flex space-x-2">
                            {task.status === 'pending' && (
                                <>
                                    <button
                                        onClick={() => handleTaskAction(task.task_id, 'cancel')}
                                        className="px-3 py-1 bg-red-100 text-red-600 rounded-lg text-sm hover:bg-red-200 transition-colors"
                                    >
                                        å–æ¶ˆ
                                    </button>
                                    <button
                                        onClick={() => handleTaskAction(task.task_id, 'pause')}
                                        className="px-3 py-1 bg-purple-100 text-purple-600 rounded-lg text-sm hover:bg-purple-200 transition-colors"
                                    >
                                        æš‚åœ
                                    </button>
                                </>
                            )}
                            {task.status === 'paused' && (
                                <button
                                    onClick={() => handleTaskAction(task.task_id, 'resume')}
                                    className="px-3 py-1 bg-blue-100 text-blue-600 rounded-lg text-sm hover:bg-blue-200 transition-colors"
                                >
                                    æ¢å¤
                                </button>
                            )}
                            {task.status === 'failed' && (
                                <button
                                    onClick={() => handleTaskAction(task.task_id, 'retry')}
                                    className="px-3 py-1 bg-yellow-100 text-yellow-600 rounded-lg text-sm hover:bg-yellow-200 transition-colors"
                                >
                                    é‡è¯•
                                </button>
                            )}
                            {['completed', 'failed', 'cancelled'].includes(task.status) && (
                                <button
                                    onClick={() => handleTaskAction(task.task_id, 'delete')}
                                    className="px-3 py-1 bg-gray-100 text-gray-600 rounded-lg text-sm hover:bg-gray-200 transition-colors"
                                >
                                    åˆ é™¤
                                </button>
                            )}
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen">
                    {/* å¯¼èˆªæ  */}
                    <nav className="bg-gradient-to-r from-kawaii-pink to-kawaii-purple shadow-lg">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between h-16 items-center">
                                <div className="flex items-center space-x-4">
                                    <h1 className="text-2xl font-bold text-white">
                                        ğŸš€ ä»»åŠ¡ç®¡ç†ä¸­å¿ƒ
                                    </h1>
                                </div>
                                <div className="flex space-x-6">
                                    <a href="/" className="text-white hover:text-kawaii-yellow transition-colors duration-300 font-medium">
                                        ğŸ  é¦–é¡µ
                                    </a>
                                    <a href="/sync" className="text-white hover:text-kawaii-yellow transition-colors duration-300 font-medium">
                                        ğŸ”„ åŒæ­¥ç®¡ç†
                                    </a>
                                    <a href="/tasks" className="text-kawaii-yellow font-medium">
                                        ğŸš€ ä»»åŠ¡ç®¡ç†
                                    </a>
                                    <a href="/stats" className="text-white hover:text-kawaii-yellow transition-colors duration-300 font-medium">
                                        ğŸ“Š ç»Ÿè®¡ä¿¡æ¯
                                    </a>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <div className="max-w-7xl mx-auto px-4 py-8">
                        {/* æ ‡é¢˜å’Œå½“å‰ä»»åŠ¡çŠ¶æ€ */}
                        <div className="mb-8">
                            <h2 className="text-3xl font-bold bg-gradient-to-r from-pink-500 via-purple-500 to-blue-500 bg-clip-text text-transparent mb-4">
                                ä»»åŠ¡ç®¡ç†ä¸­å¿ƒ ğŸ¯
                            </h2>
                            
                            {/* å½“å‰ä»»åŠ¡çŠ¶æ€ */}
                            {currentTask && (
                                <div className="bg-blue-50 border border-blue-200 rounded-2xl p-4 mb-6">
                                    <h3 className="font-semibold text-blue-800 mb-2">ğŸ”¥ å½“å‰æ‰§è¡Œä»»åŠ¡</h3>
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <span className="font-medium">{currentTask.title}</span>
                                            <span className="text-sm text-gray-600 ml-2">
                                                {currentTask.progress?.message || 'å¤„ç†ä¸­...'}
                                            </span>
                                        </div>
                                        <div className="text-sm text-blue-600">
                                            {Math.round(currentTask.progress?.percentage || 0)}%
                                        </div>
                                    </div>
                                    <div className="mt-2">
                                        <ProgressBar progress={currentTask.progress} />
                                    </div>
                                </div>
                            )}

                            {/* ç³»ç»ŸçŠ¶æ€ */}
                            {systemStatus && (
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                    <div className="bg-white/80 rounded-2xl p-4 text-center">
                                        <div className="text-2xl text-yellow-500 mb-2">â³</div>
                                        <div className="font-semibold">{systemStatus.statistics?.status_distribution?.pending || 0}</div>
                                        <div className="text-sm text-gray-600">ç­‰å¾…ä¸­</div>
                                    </div>
                                    <div className="bg-white/80 rounded-2xl p-4 text-center">
                                        <div className="text-2xl text-blue-500 mb-2">ğŸš€</div>
                                        <div className="font-semibold">{systemStatus.statistics?.status_distribution?.running || 0}</div>
                                        <div className="text-sm text-gray-600">è¿è¡Œä¸­</div>
                                    </div>
                                    <div className="bg-white/80 rounded-2xl p-4 text-center">
                                        <div className="text-2xl text-green-500 mb-2">âœ…</div>
                                        <div className="font-semibold">{systemStatus.statistics?.status_distribution?.completed || 0}</div>
                                        <div className="text-sm text-gray-600">å·²å®Œæˆ</div>
                                    </div>
                                    <div className="bg-white/80 rounded-2xl p-4 text-center">
                                        <div className="text-2xl text-red-500 mb-2">âŒ</div>
                                        <div className="font-semibold">{systemStatus.statistics?.status_distribution?.failed || 0}</div>
                                        <div className="text-sm text-gray-600">å¤±è´¥</div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* ç­›é€‰å™¨å’Œæ“ä½œ */}
                        <div className="bg-white/90 backdrop-blur-sm rounded-2xl p-6 mb-8 shadow-lg border border-pink-200/50">
                            <div className="flex flex-wrap items-center justify-between gap-4">
                                <div className="flex flex-wrap items-center gap-4">
                                    <div className="flex items-center space-x-2">
                                        <label className="text-sm font-medium text-gray-700">çŠ¶æ€ç­›é€‰:</label>
                                        <select
                                            value={statusFilter}
                                            onChange={(e) => setStatusFilter(e.target.value)}
                                            className="border border-gray-300 rounded-lg px-3 py-1 text-sm"
                                        >
                                            <option value="all">å…¨éƒ¨</option>
                                            <option value="pending">ç­‰å¾…ä¸­</option>
                                            <option value="running">è¿è¡Œä¸­</option>
                                            <option value="completed">å·²å®Œæˆ</option>
                                            <option value="failed">å¤±è´¥</option>
                                            <option value="cancelled">å·²å–æ¶ˆ</option>
                                        </select>
                                    </div>
                                    <div className="flex items-center space-x-2">
                                        <label className="text-sm font-medium text-gray-700">ç±»å‹ç­›é€‰:</label>
                                        <select
                                            value={typeFilter}
                                            onChange={(e) => setTypeFilter(e.target.value)}
                                            className="border border-gray-300 rounded-lg px-3 py-1 text-sm"
                                        >
                                            <option value="all">å…¨éƒ¨</option>
                                            <option value="video_download">è§†é¢‘ä¸‹è½½</option>
                                            <option value="sync_favorites">åŒæ­¥æ”¶è—å¤¹</option>
                                            <option value="batch_download">æ‰¹é‡ä¸‹è½½</option>
                                        </select>
                                    </div>
                                </div>
                                <div className="flex space-x-2">
                                    <button
                                        onClick={fetchTasks}
                                        className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm"
                                    >
                                        ğŸ”„ åˆ·æ–°
                                    </button>
                                    <button
                                        onClick={handleCleanupOldTasks}
                                        className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm"
                                    >
                                        ğŸ§¹ æ¸…ç†æ—§ä»»åŠ¡
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* ä»»åŠ¡åˆ—è¡¨ */}
                        <div className="bg-white/80 backdrop-blur-sm rounded-3xl shadow-xl p-8 border border-pink-200">
                            {loading && (
                                <div className="text-center py-16">
                                    <div className="inline-block animate-spin rounded-full h-16 w-16 border-4 border-kawaii-pink border-t-transparent mb-4"></div>
                                    <p className="text-kawaii-purple font-medium text-lg">æ­£åœ¨åŠ è½½ä»»åŠ¡åˆ—è¡¨... ğŸŒŸ</p>
                                </div>
                            )}

                            {!loading && tasks.length === 0 && (
                                <div className="text-center py-16">
                                    <div className="text-6xl mb-4">ğŸ“‹</div>
                                    <p className="text-gray-500 font-medium text-lg mb-4">
                                        æ²¡æœ‰æ‰¾åˆ°ä»»åŠ¡
                                    </p>
                                    <p className="text-gray-400">
                                        å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰ä»»åŠ¡ï¼Œè¯•è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶å§ âœ¨
                                    </p>
                                </div>
                            )}

                            {!loading && tasks.length > 0 && (
                                <div className="space-y-4">
                                    {tasks.map((task) => (
                                        <TaskCard key={task.task_id} task={task} />
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<TaskManager />, document.getElementById('root'));
    </script>
</body>
</html> 