<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¬ æ”¶è—å¤¹è¯¦æƒ… ğŸ¬</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/task-indicator.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'kawaii-pink': '#FFB7D1',
                        'kawaii-purple': '#C8A8E9',
                        'kawaii-blue': '#A8D8EA',
                        'kawaii-yellow': '#FFFACD',
                        'kawaii-mint': '#B8E6B8',
                    },
                    animation: {
                        'bounce-slow': 'bounce 2s infinite',
                        'pulse-slow': 'pulse 3s infinite',
                        'float': 'float 3s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap');
        * {
            font-family: 'Noto Sans SC', sans-serif;
        }
        body {
            background: linear-gradient(135deg, #FFE4E6 0%, #E8D5FF 50%, #D1E7FF 100%);
            min-height: 100vh;
        }
        .sparkle::before {
            content: 'âœ¨';
            animation: pulse 2s infinite;
        }
        .heart::before {
            content: 'ğŸ’–';
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <!-- å…¨å±€ä»»åŠ¡çŠ¶æ€æŒ‡ç¤ºå™¨å®¹å™¨ -->
    <div id="task-indicator-container"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // æ ¼å¼åŒ–æ—¶é•¿çš„å‡½æ•°
        const formatDuration = (seconds) => {
            if (!seconds || seconds <= 0) return '00:00:00';
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        };

        function App() {
            const [collection, setCollection] = useState(null);
            const [videos, setVideos] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [statusFilter, setStatusFilter] = useState('all');
            const [collectionId, setCollectionId] = useState(null);
            const [pagination, setPagination] = useState({
                page: 1,
                page_size: 20,
                total: 0,
                total_pages: 0
            });

            useEffect(() => {
            const pathParts = window.location.pathname.split('/');
                const id = pathParts[pathParts.length - 1];
                setCollectionId(id);
                fetchCollectionInfo(id);
                fetchVideos(id);
            }, []);

            const fetchCollectionInfo = async (id) => {
                try {
                    const response = await fetch('/api/collections');
                    const collections = await response.json();
                    const currentCollection = collections.find(c => c.id == id);
                    setCollection(currentCollection);
                } catch (err) {
                    console.error('Error fetching collection info:', err);
                }
            };

            const fetchVideos = async (id, search = '', status = 'all', page = 1) => {
                try {
                    setLoading(true);
                    let apiUrl = `/api/collections/${id}/videos?page=${page}&page_size=20`;
                if (status !== 'all') {
                    apiUrl += `&status=${status}`;
                }
                    if (search) {
                        apiUrl += `&search=${encodeURIComponent(search)}`;
                    }

                    console.log('Fetching videos from:', apiUrl); // ä¸´æ—¶è°ƒè¯•

                    const response = await fetch(apiUrl);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                    const data = await response.json();
                    console.log('API Response:', data); // ä¸´æ—¶è°ƒè¯•
                    
                    // æ ¹æ®å®é™…APIå“åº”æ ¼å¼å¤„ç†æ•°æ®
                    if (data.pagination) {
                        // æ ‡å‡†åˆ†é¡µæ ¼å¼: {data: [...], pagination: {...}}
                        setVideos(data.data || []);
                        setPagination(data.pagination);
                    } else if (data.items && Array.isArray(data.items)) {
                        // APIè¿”å›æ ¼å¼: {items: [...], page: 1, page_size: 20, total: 827, total_pages: 42}
                        setVideos(data.items);
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰åˆ†é¡µä¿¡æ¯å­—æ®µ
                        if (data.page !== undefined && data.total !== undefined) {
                            setPagination({
                                page: data.page || page,
                                page_size: data.page_size || 20,
                                total: data.total,
                                total_pages: data.total_pages || Math.ceil(data.total / (data.page_size || 20))
                            });
                        } else {
                            // å¦‚æœæ²¡æœ‰åˆ†é¡µä¿¡æ¯ï¼Œä½¿ç”¨collection.media_countè®¡ç®—
                            const totalCount = collection ? collection.media_count : data.items.length;
                            const pageSize = 20;
                            setPagination({
                                page: page,
                                page_size: pageSize,
                                total: totalCount,
                                total_pages: Math.ceil(totalCount / pageSize)
                            });
                        }
                    } else if (Array.isArray(data)) {
                        // ç›´æ¥æ•°ç»„æ ¼å¼: [...]
                        setVideos(data);
                        const totalCount = collection ? collection.media_count : data.length;
                        const pageSize = 20;
                        setPagination({
                            page: page,
                            page_size: pageSize,
                            total: totalCount,
                            total_pages: Math.ceil(totalCount / pageSize)
                        });
                    } else {
                        // å…¶ä»–æ ¼å¼ï¼Œé»˜è®¤å¤„ç†
                        setVideos([]);
                        setPagination({
                            page: 1,
                            page_size: 20,
                            total: 0,
                            total_pages: 1
                        });
                    }

                    console.log('Final pagination:', pagination); // ä¸´æ—¶è°ƒè¯•
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleSearch = () => {
                if (collectionId) {
                    fetchVideos(collectionId, searchTerm, statusFilter, 1);
                }
            };

            const handlePageChange = (newPage) => {
                if (collectionId && newPage >= 1 && newPage <= pagination.total_pages) {
                    fetchVideos(collectionId, searchTerm, statusFilter, newPage);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    handleSearch();
                }
            };

            // åˆ†é¡µç»„ä»¶ - é€šè¿‡propsç®¡ç†è‡ªå·±çš„æ•°æ®
            const PaginationComponent = ({ currentPage, totalPages, onPageChange }) => {
                // åªæœ‰è¶…è¿‡1é¡µæ—¶æ‰æ˜¾ç¤ºåˆ†é¡µ
                if (totalPages <= 1) {
                    return null;
                }

                const getPageNumbers = () => {
                    const pages = [];
                    const maxVisiblePages = 5; // æœ€å¤šæ˜¾ç¤º5ä¸ªé¡µç 

                    if (totalPages <= maxVisiblePages) {
                        // æ€»é¡µæ•°ä¸è¶…è¿‡5é¡µï¼Œæ˜¾ç¤ºæ‰€æœ‰é¡µç 
                        for (let i = 1; i <= totalPages; i++) {
                            pages.push(i);
                        }
                    } else {
                        // æ€»é¡µæ•°è¶…è¿‡5é¡µï¼Œéœ€è¦æ™ºèƒ½æ˜¾ç¤º
                        if (currentPage <= 3) {
                            // å½“å‰é¡µåœ¨å‰3é¡µï¼š[1][2][3][4]...[last]
                            for (let i = 1; i <= 4; i++) {
                                pages.push(i);
                            }
                            pages.push('...');
                            pages.push(totalPages);
                        } else if (currentPage >= totalPages - 2) {
                            // å½“å‰é¡µåœ¨å3é¡µï¼š[1]...[last-3][last-2][last-1][last]
                            pages.push(1);
                            pages.push('...');
                            for (let i = totalPages - 3; i <= totalPages; i++) {
                                pages.push(i);
                            }
                        } else {
                            // å½“å‰é¡µåœ¨ä¸­é—´ï¼š[1]...[current-1][current][current+1]...[last]
                            pages.push(1);
                            pages.push('...');
                            pages.push(currentPage - 1);
                            pages.push(currentPage);
                            pages.push(currentPage + 1);
                            pages.push('...');
                            pages.push(totalPages);
                        }
                    }
                    return pages;
                };

                return (
                    <div className="flex items-center justify-center space-x-2 mt-8">
                        {/* ä¸Šä¸€é¡µæŒ‰é’® */}
                        <button
                            onClick={() => onPageChange(currentPage - 1)}
                            disabled={currentPage <= 1}
                            className={`px-4 py-2 rounded-xl font-medium transition-all duration-300 ${
                                currentPage <= 1
                                    ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                                    : 'bg-gradient-to-r from-kawaii-blue to-kawaii-purple text-white hover:shadow-lg transform hover:-translate-y-1'
                            }`}
                        >
                            â† ä¸Šä¸€é¡µ
                        </button>

                        {/* é¡µç æŒ‰é’® */}
                        {getPageNumbers().map((page, index) => (
                            <button
                                key={index}
                                onClick={() => typeof page === 'number' && onPageChange(page)}
                                disabled={page === '...'}
                                className={`w-10 h-10 rounded-xl font-medium transition-all duration-300 ${
                                    page === currentPage
                                        ? 'bg-gradient-to-r from-kawaii-pink to-kawaii-purple text-white shadow-lg'
                                        : page === '...'
                                        ? 'text-gray-400 cursor-default'
                                        : 'bg-white text-gray-600 hover:bg-gradient-to-r hover:from-kawaii-pink hover:to-kawaii-purple hover:text-white hover:shadow-md transform hover:-translate-y-1'
                                }`}
                            >
                                {page}
                            </button>
                        ))}

                        {/* ä¸‹ä¸€é¡µæŒ‰é’® */}
                        <button
                            onClick={() => onPageChange(currentPage + 1)}
                            disabled={currentPage >= totalPages}
                            className={`px-4 py-2 rounded-xl font-medium transition-all duration-300 ${
                                currentPage >= totalPages
                                    ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                                    : 'bg-gradient-to-r from-kawaii-blue to-kawaii-purple text-white hover:shadow-lg transform hover:-translate-y-1'
                            }`}
                        >
                            ä¸‹ä¸€é¡µ â†’
                        </button>
                    </div>
                );
            };

            // è§†é¢‘ä¸‹è½½åŠŸèƒ½
            const handleDownloadVideo = async (video, quality = 80) => {
                try {
                    const response = await fetch('/api/tasks/download', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            bvid: video.bvid,
                            quality: quality,
                            page: 0
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        alert(`ä¸‹è½½ä»»åŠ¡å·²æäº¤! ä»»åŠ¡ID: ${result.task_id}\nè¯·å‰å¾€ä»»åŠ¡ç®¡ç†é¡µé¢æŸ¥çœ‹è¿›åº¦`);
                    } else {
                        const error = await response.json();
                        alert(`æäº¤ä¸‹è½½ä»»åŠ¡å¤±è´¥: ${error.detail || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                } catch (err) {
                    alert(`ä¸‹è½½ä»»åŠ¡æäº¤å¤±è´¥: ${err.message}`);
                }
            };

            // æ˜¾ç¤ºä¸‹è½½é€‰é¡¹å¼¹çª—
            const showDownloadOptions = (video) => {
                const quality = prompt(
                    `é€‰æ‹©è§†é¢‘è´¨é‡:\n` +
                    `16 - 360P\n` +
                    `32 - 480P\n` +
                    `64 - 720P\n` +
                    `80 - 1080P (é»˜è®¤)\n` +
                    `112 - 1080P+\n\n` +
                    `è¯·è¾“å…¥è´¨é‡ä»£ç :`,
                    '80'
                );
                
                if (quality !== null) {
                    const qualityNum = parseInt(quality);
                    if ([16, 32, 64, 80, 112].includes(qualityNum)) {
                        handleDownloadVideo(video, qualityNum);
                    } else {
                        alert('æ— æ•ˆçš„è´¨é‡ä»£ç ï¼');
                    }
                }
            };

            return (
                <div className="min-h-screen">
                    <nav className="bg-gradient-to-r from-kawaii-pink to-kawaii-purple shadow-lg">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between h-16 items-center">
                                <div className="flex items-center space-x-4">
                                    <a href="/" className="text-white hover:text-kawaii-yellow transition-colors duration-300 font-medium">
                                        â† è¿”å›é¦–é¡µ
                                    </a>
                                    <h1 className="text-xl font-bold text-white sparkle">
                                        {collection ? collection.title : 'æ”¶è—å¤¹è¯¦æƒ…'}
                                    </h1>
                                </div>
                                <div className="flex space-x-6">
                                    <a href="/" className="text-white hover:text-kawaii-yellow transition-colors duration-300 font-medium">
                                        ğŸ  é¦–é¡µ
                                    </a>
                                    <a href="/sync" className="text-white hover:text-kawaii-yellow transition-colors duration-300 font-medium">
                                        ğŸ”„ åŒæ­¥ç®¡ç†
                                    </a>
                                    <a href="/tasks" className="text-white hover:text-kawaii-yellow transition-colors duration-300 font-medium">
                                        ğŸš€ ä»»åŠ¡ç®¡ç†
                                    </a>
                                    <a href="/stats" className="text-white hover:text-kawaii-yellow transition-colors duration-300 font-medium">
                                        ğŸ“Š ç»Ÿè®¡ä¿¡æ¯
                                    </a>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <div className="max-w-7xl mx-auto px-4 py-8">
                        {collection && (
                            <div className="bg-white/80 backdrop-blur-sm rounded-3xl shadow-xl p-6 mb-8 border border-pink-200">
                                <div className="flex items-center space-x-4">
                                    <div className="text-4xl">ğŸ“</div>
                                    <div>
                                        <h2 className="text-2xl font-bold bg-gradient-to-r from-pink-500 via-purple-500 to-blue-500 bg-clip-text text-transparent">
                                            {collection.title}
                                        </h2>
                                        <p className="text-gray-600">
                                            Bç«™ID: {collection.bilibili_fid} | å…± {collection.media_count || 0} ä¸ªè§†é¢‘
                                            {pagination.total > 0 && (
                                                <span className="ml-2">
                                                    | å½“å‰ç¬¬ {pagination.page} é¡µï¼Œå…± {pagination.total_pages} é¡µ
                                                </span>
                                            )}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-6 mb-8 border border-pink-200">
                            <div className="flex flex-col sm:flex-row gap-4">
                                <div className="flex-1">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">ğŸ” æœç´¢è§†é¢‘æ ‡é¢˜</label>
                                    <input
                                        type="text"
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        onKeyPress={handleKeyPress}
                                        placeholder="è¾“å…¥å…³é”®è¯æœç´¢..."
                                        className="w-full px-4 py-3 border border-pink-200 rounded-xl focus:ring-2 focus:ring-kawaii-purple focus:border-transparent transition-all duration-300"
                                    />
                                </div>
                                <div className="sm:w-48">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">ğŸ“Š çŠ¶æ€ç­›é€‰</label>
                                    <select
                                        value={statusFilter}
                                        onChange={(e) => setStatusFilter(e.target.value)}
                                        className="w-full px-4 py-3 border border-pink-200 rounded-xl focus:ring-2 focus:ring-kawaii-purple focus:border-transparent transition-all duration-300"
                                    >
                                        <option value="all">æ‰€æœ‰çŠ¶æ€</option>
                                        <option value="available">âœ… æœ‰æ•ˆè§†é¢‘</option>
                                        <option value="deleted">âŒ å·²å¤±æ•ˆ</option>
                                    </select>
                                </div>
                                <div className="sm:w-32 flex items-end">
                                    <button
                                        onClick={handleSearch}
                                        className="w-full bg-gradient-to-r from-kawaii-pink to-kawaii-purple text-white font-medium py-3 px-6 rounded-xl hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1"
                                    >
                                        ğŸ” ç­›é€‰
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white/80 backdrop-blur-sm rounded-3xl shadow-xl p-8 border border-pink-200">
                            {loading && (
                                <div className="text-center py-16">
                                    <div className="inline-block animate-spin rounded-full h-16 w-16 border-4 border-kawaii-pink border-t-transparent mb-4"></div>
                                    <p className="text-kawaii-purple font-medium text-lg">æ­£åœ¨åŠ è½½è§†é¢‘ä¸­... ğŸŒŸ</p>
                                </div>
                            )}

                            {error && (
                                <div className="text-center py-16">
                                    <div className="text-6xl mb-4">ğŸ˜¿</div>
                                    <p className="text-red-500 font-medium text-lg mb-4">
                                        åŠ è½½è§†é¢‘å¤±è´¥: {error}
                                    </p>
                                    <p className="text-gray-500">
                                        è¯·æ£€æŸ¥APIæœåŠ¡å’Œæ•°æ®åº“è¿æ¥ ğŸ”§
                                    </p>
                                </div>
                            )}

                            {!loading && !error && videos.length === 0 && (
                                <div className="text-center py-16">
                                    <div className="text-6xl mb-4">ğŸ“º</div>
                                    <p className="text-gray-500 font-medium text-lg mb-4">
                                        æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è§†é¢‘
                                    </p>
                                    <p className="text-gray-400">
                                        è¯•è¯•è°ƒæ•´æœç´¢æ¡ä»¶æˆ–ç­›é€‰å™¨ ğŸ’«
                                    </p>
                                </div>
                            )}

                            {!loading && !error && videos.length > 0 && (
                                <>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                        {videos.map((video) => (
                                            <div
                                                key={video.bvid}
                                                className={`group relative bg-gradient-to-br from-white to-pink-50 rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 border border-pink-100 ${
                                                    video.is_deleted ? 'opacity-75' : ''
                                                }`}
                                            >
                                                <div className="relative aspect-video overflow-hidden">
                                                    <img
                                                        src={video.local_cover_path ? 
                                                            `/covers/${video.local_cover_path.split('/').pop().split('\\').pop()}` : 
                                                            '/static/nocover.webp'
                                                        }
                                                        alt={video.title}
                                                        className={`w-full h-full object-cover transition-transform duration-300 group-hover:scale-105 ${
                                                            video.is_deleted ? 'grayscale' : ''
                                                        }`}
                                                        onError={(e) => {
                                                            e.target.src = '/static/load_failed.webp';
                                                        }}
                                                    />
                                                    
                                                    {/* è§†é¢‘æ—¶é•¿æ˜¾ç¤ºåœ¨å³ä¸‹è§’ */}
                                                    {video.duration && (
                                                        <div className="absolute bottom-2 right-2 bg-black/75 text-white text-xs font-medium px-2 py-1 rounded-md">
                                                            {formatDuration(video.duration)}
                                                        </div>
                                                    )}
                                                    
                                                    {video.is_deleted && (
                                                        <div className="absolute inset-0 bg-red-500/20 flex items-center justify-center">
                                                            <span className="bg-red-500 text-white px-3 py-1 rounded-full text-sm font-medium">
                                                                âŒ å·²å¤±æ•ˆ
                                                            </span>
                                                        </div>
                                                    )}
                                                </div>

                                                <div className="p-4">
                                                    <h3 className={`font-bold text-sm text-gray-800 mb-2 line-clamp-2 group-hover:text-kawaii-purple transition-colors duration-300 ${
                                                        video.is_deleted ? 'line-through text-gray-400' : ''
                                                    }`}>
                                                        {video.title}
                                                    </h3>
                                                    
                                                    <div className="space-y-2 text-xs text-gray-600">
                                                        <div className="flex items-center space-x-1">
                                                            <span>ğŸ‘¤</span>
                                                            <span>{video.uploader_name || 'N/A'}</span>
                                                        </div>
                                                        <div className="flex items-center space-x-1">
                                                            <span>ğŸ†”</span>
                                                            <span className="font-mono">{video.bvid}</span>
                                                        </div>
                                                        <div className="flex items-center space-x-1">
                                                            <span>ğŸ’–</span>
                                                            <span>æ”¶è—äº: {new Date(video.fav_time * 1000).toLocaleDateString()}</span>
                                                        </div>
                                                    </div>

                                                    {!video.is_deleted && (
                                                        <div className="mt-3 pt-3 border-t border-pink-100">
                                                            <div className="flex items-center justify-between">
                                                                <a 
                                                                    href={`https://www.bilibili.com/video/${video.bvid}`}
                                                                    target="_blank"
                                                                    rel="noopener noreferrer"
                                                                    className="inline-flex items-center space-x-1 text-kawaii-purple hover:text-kawaii-pink transition-colors duration-300 text-sm font-medium"
                                                                >
                                                                    <span>ğŸ¬</span>
                                                                    <span>å‰å¾€è§‚çœ‹</span>
                                                                </a>
                                                                <button
                                                                    onClick={() => showDownloadOptions(video)}
                                                                    className="inline-flex items-center space-x-1 bg-gradient-to-r from-kawaii-blue to-kawaii-mint text-white hover:from-kawaii-mint hover:to-kawaii-blue transition-all duration-300 text-xs font-medium px-3 py-1 rounded-lg transform hover:scale-105"
                                                                    title="ä¸‹è½½æ­¤è§†é¢‘"
                                                                >
                                                                    <span>â¬‡ï¸</span>
                                                                    <span>ä¸‹è½½</span>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>

                                    {/* ä½¿ç”¨é‡æ„åçš„åˆ†é¡µç»„ä»¶ï¼Œé€šè¿‡propsä¼ é€’æ•°æ® */}
                                    <PaginationComponent 
                                        currentPage={pagination.page}
                                        totalPages={pagination.total_pages}
                                        onPageChange={handlePageChange}
                                    />
                                </>
                            )}
                        </div>

                        <div className="text-center mt-12 text-gray-500">
                            <p className="heart">
                                Made with love for anime lovers ğŸ’–
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
